---
title: "Allianz DataViz Challenge"
author: "Daniel Bader"
output:
  html_notebook:
    toc: yes
    toc_float: yes
  html_document:
    toc: yes
    toc_float: yes
---

```{r, message=FALSE, echo=T}
library(plotly)
library(data.table)
library(tidyr)
library(knitr)
library(heatmaply)
```


```{r, echo=FALSE}
opts_chunk$set(echo=FALSE, cache=F)
total_customers <- 195387
file_bookstore <- file.path("~/Downloads/toydata/book_genres_data.csv")
source("build_book_store.R")
```


# Preprocessing

* Load data file
* rename genres for better readability
    * "Religion, Spirituality & New Age" to "Religion"
    * "Science.fiction" to "SciFi"
    * "Action.and.Adventure" to "Action"
    
All genres:
```{r}
books_mat <- read.csv(file_bookstore, row.names = 1)
rownames(books_mat) <- make.names(rownames(books_mat))
rownames(books_mat) <- sub("Science.fiction", "SciFi", rownames(books_mat))
rownames(books_mat) <- sub("Action.and.Adventure", "Action", rownames(books_mat))
rownames(books_mat) <- sub("Religion..Spirituality...New.Age", 
    "Religion", rownames(books_mat)
)
colnames(books_mat) <- rownames(books_mat)
rownames(books_mat)
```

* Check if upper and lower triangle identical

```{r}
is_upper_lower <- identical(
    books_mat[upper.tri(books_mat)], 
    t(books_mat)[upper.tri(books_mat)]
)
is_upper_lower
```

* Transform to long and tidy `data.table`

```{r}
books_dt <- as.data.table(books_mat, keep.rownames = TRUE)
setnames(books_dt, c('genreA',colnames(books_mat)))
books_dt <- as.data.table(gather(books_dt, genreB, customers, Satire:Journals))
```

```{r, echo=T}
head(books_dt)
```


* Average number of genres per customer

```{r}
sum(books_dt[genreA==genreB, customers])/total_customers
```


# First ideas

## Show me everything!

```{r, fig.width=8, fig.height=8}
hm <- heatmapr(books_mat)
heatmaply(hm, 
    plot_method = 'plotly', 
    colors =  c('grey95', 'dodgerblue')
)
```

* Romance, SciFi, Action, History are most bought 
* bought-together clusters:
    * Romance, SciFi, Action, History
    * Dictionaries and Comics
    * Math and Poetry
* Mystery is an outlier

## Most bought genre

```{r}
plot_ly(data=books_dt[genreA==genreB][order(customers)], 
    x=~genreA, y=~customers, type="bar"
)%>% layout(
    margin=list(b=100), 
    xaxis=list(categoryorder="trace"),
    title="Most bought genre"
)
```

## Best pairs

```{r}
all_genres <- unique(books_dt$genreA)
all_pairs <- combn(all_genres, 2, simplify = F)
pair_customers <- 
pair_dt <- data.table(
    genre_pairs = sapply(all_pairs, function(p){
        paste(sort(p), collapse = "&")}
    ),
    pair_customers = sapply(all_pairs, function(p){
        books_dt[genreA==p[1] & genreB==p[2], customers]
    })
)
plot_ly(data=pair_dt[order(pair_customers, decreasing=T)][1:10], type='bar', 
    x=~genre_pairs, y=~pair_customers
)%>% layout(
    margin=list(b=100), 
    xaxis=list(categoryorder="trace"),
    title="Top 10 genre pairs"
)
```

* mostly combinations of most bought genres


# Special genres

Hypothesis

* If a customer buys more than 2 genres, 
he is recorded in more than 1 off-diagonal entry
--> (2*diagonal - colSum) < 0
* If a genre is bought more often alone than in triplets (or higher): (2*diagonal - colSum) > 0


Look for customers that buy only one genre

* Compare `column sum` and  `2*diagonal value`
* generate table with 
`{genreA=<genre>, genreB=NA,  customers={2*diagonal-colSum}}`


```{r}
all_genres <- unique(books_dt$genreA)
selective_dt <- data.table()
tmp <- sapply(all_genres, function(g){
    d <- books_dt[genreA==g & genreB==g, customers]
    cs <- sum(books_dt[genreA==g, customers])
    selective_customers <- I(2*d - cs)#;selective_customers
    selective_dt <<- rbind(selective_dt, 
        data.table(genreA=g, genreB=NA, diag_diff=selective_customers)
    )
})

p_sel <- plot_ly(data=selective_dt[order(diag_diff)], 
    y=~genreA, x=~diag_diff, type="bar", color = ~diag_diff>0
)%>% layout(
    margin=list(l=100), 
    yaxis=list(categoryorder="trace", title=''),
    xaxis=list(title='2*diagonal - columnSum'),
    title="Which genres are bought alone?"
)
```
```{r,warning=FALSE, fig.width=8}
show(p_sel)
```

